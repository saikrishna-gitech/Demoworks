#!/bin/bash

# Set time threshold (5 hours ago)
THRESHOLD=$(date -d '-5 hours' +%s)

echo "Checking for openshift-debug-* namespaces older than 5 hours..."

# List all namespaces starting with openshift-debug-
for ns in $(oc get ns -o json | jq -r '.items[] | select(.metadata.name | test("^openshift-debug-")) | .metadata.name'); do
    # Get creation timestamp and convert to epoch
    creation_time=$(oc get ns "$ns" -o jsonpath='{.metadata.creationTimestamp}')
    creation_epoch=$(date -d "$creation_time" +%s)

    if [[ "$creation_epoch" -lt "$THRESHOLD" ]]; then
        echo "Namespace: $ns"
        echo "  Created at: $creation_time"

        # Try to find who created it from audit logs (requires audit logging enabled and access)
        creator=$(oc adm node-logs --role=master -u kube-apiserver | grep "create.*namespace.*\"$ns\"" | tail -1 | jq -r '.user.username // "Unknown"')
        echo "  Created by: $creator"

        echo "  Deleting namespace: $ns"
        oc delete ns "$ns"
        echo ""
    fi
done