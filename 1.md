#!/bin/bash

# Time threshold (5 hours ago)
TIME_THRESHOLD=$(date -u -d '5 hours ago' +%s)

echo "Checking for namespaces created before: $(date -d @$TIME_THRESHOLD)"

# Output file
OUTPUT="/tmp/namespace_creation_report.txt"
echo "Namespace | Created At (UTC) | Created By" > "$OUTPUT"
echo "------------------------------------------" >> "$OUTPUT"

# Loop through all namespaces
for ns in $(oc get ns --no-headers | awk '{print $1}'); do
  # Get creation timestamp
  created_at=$(oc get ns "$ns" -o jsonpath='{.metadata.creationTimestamp}')
  created_epoch=$(date -u -d "$created_at" +%s)

  # Check if namespace is older than 5 hours
  if [ "$created_epoch" -lt "$TIME_THRESHOLD" ]; then
    # Try to find creator from audit logs (example assumes logs in /var/log/audit)
    creator=$(grep -m 1 "create.*$ns" /var/log/audit/audit.log | grep 'user=' | sed -n 's/.*user="\([^"]*\)".*/\1/p')
    echo "$ns | $created_at | ${creator:-unknown}" >> "$OUTPUT"
  fi
done

cat "$OUTPUT"